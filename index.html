<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity Builder - Afterhours</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body style="margin: 0;">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const SUPABASE_URL = 'https://aeusujfuxnxwbvccmusk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFldXN1amZ1eG54d2J2Y2NtdXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5MDAwNDAsImV4cCI6MjA1NzQ3NjA0MH0.rMuOA4LyVVao4_alpNopj2E4mpzEHYxBOMJxv6jrOVA';
    const APP_URL = 'https://app.afths.com';
    const HEADERS = { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY };

    async function sbFetch(table, params) {
      const url = SUPABASE_URL + '/rest/v1/' + table + '?select=*&' + params;
      const res = await fetch(url, { headers: HEADERS });
      if (!res.ok) throw new Error(table + ': ' + res.statusText);
      return res.json();
    }

    function ActivityBuilder() {
      const [areas, setAreas] = useState([]);
      const [courses, setCourses] = useState([]);
      const [selectedCourse, setSelectedCourse] = useState(null);
      const [activities, setActivities] = useState({});
      const [selectedTopic, setSelectedTopic] = useState(null);
      const [toasts, setToasts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [dragIdx, setDragIdx] = useState(null);
      const [dragOverIdx, setDragOverIdx] = useState(null);
      const [savedOrder, setSavedOrder] = useState({});
      const [saving, setSaving] = useState(false);
      const [edits, setEdits] = useState({});
      const [editingField, setEditingField] = useState(null);

      const showToast = (msg, type = "info") => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, msg, type }]);
        setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
      };

      // Fetch all data from Supabase on mount
      useEffect(() => {
        async function fetchAll() {
          try {
            setLoading(true);
            setError(null);

            const [areasData, coursesData, levelsData, topicsData, activitiesData] = await Promise.all([
              sbFetch('areas', 'order=order_number'),
              sbFetch('courses', 'order=title'),
              sbFetch('levels', 'order=order_number'),
              sbFetch('topics', 'order=order_number'),
              sbFetch('activities', 'order=order_number'),
            ]);

            // Build hierarchical course data
            const topicsByLevel = {};
            topicsData.forEach(t => {
              if (!topicsByLevel[t.level_id]) topicsByLevel[t.level_id] = [];
              topicsByLevel[t.level_id].push(t);
            });

            const levelsByCourse = {};
            levelsData.forEach(l => {
              if (!levelsByCourse[l.course_id]) levelsByCourse[l.course_id] = [];
              levelsByCourse[l.course_id].push({
                ...l,
                topics: (topicsByLevel[l.id] || []).sort((a, b) => a.order_number - b.order_number),
              });
            });

            const builtCourses = coursesData.map(c => ({
              ...c,
              levels: (levelsByCourse[c.id] || []).sort((a, b) => a.order_number - b.order_number),
            }));

            // Group activities by topic_id
            const grouped = {};
            activitiesData.forEach(a => {
              if (!grouped[a.topic_id]) grouped[a.topic_id] = [];
              grouped[a.topic_id].push(a);
            });

            // Store original order for change detection
            const orderSnap = {};
            Object.entries(grouped).forEach(([tid, acts]) => {
              orderSnap[tid] = acts.map(a => a.id);
            });

            setAreas(areasData);
            setCourses(builtCourses);
            setActivities(grouped);
            setSavedOrder(orderSnap);
            setLoading(false);
            showToast(
              `Loaded ${builtCourses.length} courses, ${activitiesData.length} activities`,
              "success"
            );
          } catch (err) {
            console.error('[ActivityBuilder] Error:', err);
            setError(err.message);
            setLoading(false);
            showToast("Error loading data: " + err.message, "error");
          }
        }
        fetchAll();
      }, []);

      const getActivitiesForTopic = (topicId) => activities[topicId] || [];
      const backToTopics = () => { setSelectedTopic(null); setEdits({}); setEditingField(null); };
      const backToCourses = () => { setSelectedCourse(null); setSelectedTopic(null); setEdits({}); setEditingField(null); };

      const orderChanged = selectedTopic && savedOrder[selectedTopic.id] &&
        JSON.stringify((activities[selectedTopic.id] || []).map(a => a.id)) !== JSON.stringify(savedOrder[selectedTopic.id]);
      const hasEdits = Object.keys(edits).length > 0;
      const hasChanges = orderChanged || hasEdits;

      const onDrop = (topicId, fromIdx, toIdx) => {
        if (fromIdx === toIdx) return;
        setActivities(prev => {
          const list = [...(prev[topicId] || [])];
          const [moved] = list.splice(fromIdx, 1);
          list.splice(toIdx, 0, moved);
          return { ...prev, [topicId]: list };
        });
      };

      const stageEdit = (activityId, field, value, optIdx) => {
        setEdits(prev => {
          const ae = { ...prev[activityId] };
          if (field === 'main_text') {
            ae.main_text = value;
          } else if (field === 'option') {
            ae.options = ae.options || {};
            ae.options[optIdx] = value;
          } else if (field === 'explanation') {
            ae.explanations = ae.explanations || {};
            ae.explanations[optIdx] = value;
          }
          return { ...prev, [activityId]: ae };
        });
      };

      const saveChanges = async () => {
        if (!selectedTopic || saving) return;
        const list = activities[selectedTopic.id] || [];
        setSaving(true);
        try {
          const patches = list.map((a, i) => {
            const body = { order_number: i + 1 };
            const e = edits[a.id];
            if (e) {
              if (e.main_text !== undefined) body.main_text = e.main_text;
              if (e.options) {
                const opts = [...(a.options || [])];
                Object.entries(e.options).forEach(([idx, val]) => { opts[Number(idx)] = val; });
                body.options = opts;
              }
              if (e.explanations) {
                let expl = a.explanation;
                if (Array.isArray(expl)) {
                  expl = [...expl];
                  Object.entries(e.explanations).forEach(([idx, val]) => { expl[Number(idx)] = val; });
                } else {
                  // Convert to array
                  const len = (a.options || []).length;
                  expl = Array.from({ length: len }, (_, k) => getOptionExplanation(a, k));
                  Object.entries(e.explanations).forEach(([idx, val]) => { expl[Number(idx)] = val; });
                }
                body.explanation = expl;
              }
            }
            return fetch(SUPABASE_URL + '/rest/v1/activities?id=eq.' + a.id, {
              method: 'PATCH',
              headers: { ...HEADERS, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
              body: JSON.stringify(body),
            }).then(r => { if (!r.ok) throw new Error('Failed to update ' + a.id); });
          });
          await Promise.all(patches);
          // Apply edits into local activity state so UI reflects saved data
          setActivities(prev => {
            const updated = [...(prev[selectedTopic.id] || [])];
            updated.forEach((a, i) => {
              const e = edits[a.id];
              if (e) {
                if (e.main_text !== undefined) updated[i] = { ...a, main_text: e.main_text };
                if (e.options) {
                  const opts = [...(updated[i].options || [])];
                  Object.entries(e.options).forEach(([idx, val]) => { opts[Number(idx)] = val; });
                  updated[i] = { ...updated[i], options: opts };
                }
                if (e.explanations) {
                  let expl = updated[i].explanation;
                  if (Array.isArray(expl)) {
                    expl = [...expl];
                  } else {
                    const len = (updated[i].options || []).length;
                    expl = Array.from({ length: len }, (_, k) => getOptionExplanation(updated[i], k));
                  }
                  Object.entries(e.explanations).forEach(([idx, val]) => { expl[Number(idx)] = val; });
                  updated[i] = { ...updated[i], explanation: expl };
                }
              }
            });
            return { ...prev, [selectedTopic.id]: updated };
          });
          setSavedOrder(prev => ({ ...prev, [selectedTopic.id]: list.map(a => a.id) }));
          setEdits({});
          showToast('Changes saved', 'success');
        } catch (err) {
          showToast('Save failed: ' + err.message, 'error');
        }
        setSaving(false);
      };

      const getTypeBreakdown = (topicActivities) => {
        const breakdown = {};
        topicActivities.forEach(act => {
          const type = ['poll', 'text_poll', 'image_poll', 'number_poll'].includes(act.type) ? 'poll' : act.type;
          breakdown[type] = (breakdown[type] || 0) + 1;
        });
        return breakdown;
      };

      const typeColors = {
        multiple_choice: '#3B82F6',
        true_false: '#10B981',
        poll: '#F59E0B',
        sorting: '#8B5CF6',
        myth_or_reality: '#EC4899',
        image_multiple_choice: '#06B6D4',
        pair_matching: '#EF4444',
        text_input: '#6366F1',
        eduntainment: '#14B8A6'
      };

      const typeLabels = {
        multiple_choice: 'Multiple Choice',
        true_false: 'True/False',
        poll: 'Poll',
        sorting: 'Sorting',
        myth_or_reality: 'Myth or Reality',
        image_multiple_choice: 'Image Multiple Choice',
        pair_matching: 'Pair Matching',
        text_input: 'Text Input',
        eduntainment: 'Edutainment'
      };

      const isCorrectOption = (activity, optionIndex) => {
        const { correct_answer } = activity;
        return Array.isArray(correct_answer) ? correct_answer.includes(optionIndex) : correct_answer === optionIndex;
      };

      // Get explanation text for an option
      const getOptionExplanation = (activity, optIdx) => {
        const { explanation } = activity;
        if (!explanation) return "";
        if (Array.isArray(explanation)) return explanation[optIdx] || "";
        if (typeof explanation === 'object' && explanation.default) return optIdx === 0 ? explanation.default : "";
        if (typeof explanation === 'string') return optIdx === 0 ? explanation : "";
        return "";
      };

      // Inline editable text component
      const EditableText = ({ value, onCommit, fieldKey, style, multiline }) => {
        const isEditing = editingField === fieldKey;
        const ref = useRef(null);
        const staged = edits[fieldKey.split(':')[0]]; // check if there's a staged edit
        const commit = useCallback((val) => {
          if (val !== value) onCommit(val);
          setEditingField(null);
        }, [value, onCommit]);

        useEffect(() => {
          if (isEditing && ref.current) {
            ref.current.focus();
            // Move cursor to end
            const el = ref.current;
            if (el.setSelectionRange) el.setSelectionRange(el.value.length, el.value.length);
          }
        }, [isEditing]);

        if (isEditing) {
          const inputStyle = { ...style, width: '100%', boxSizing: 'border-box', border: '1px solid #8B4513', borderRadius: 4, padding: '4px 6px', outline: 'none', fontFamily: 'inherit', resize: multiline ? 'vertical' : 'none' };
          if (multiline) return <textarea ref={ref} defaultValue={value} rows={2} style={inputStyle} onBlur={(e) => commit(e.target.value)} onKeyDown={(e) => { if (e.key === 'Escape') setEditingField(null); }} />;
          return <input ref={ref} defaultValue={value} style={inputStyle} onBlur={(e) => commit(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') setEditingField(null); }} />;
        }
        return <div onClick={() => setEditingField(fieldKey)} style={{ ...style, cursor: 'text', borderBottom: '1px dashed transparent' }} onMouseEnter={(e) => e.currentTarget.style.borderBottomColor = '#D4C4B0'} onMouseLeave={(e) => e.currentTarget.style.borderBottomColor = 'transparent'}>{value || <span style={{ color: '#CCC', fontStyle: 'italic' }}>Click to edit</span>}</div>;
      };

      const container = { minHeight: "100vh", background: "linear-gradient(135deg, #FAF8F5 0%, #F5F1E8 100%)", padding: "16px 12px", fontFamily: "'Inter', -apple-system, sans-serif" };
      const btnSecondary = { background: "white", color: "#8B4513", border: "1px solid #D4C4B0", padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontSize: 12, fontWeight: 500, transition: "all 0.2s" };
      const card = { background: "white", borderRadius: 8, padding: 12, boxShadow: "0 1px 4px rgba(0,0,0,0.06)", marginBottom: 8, border: "1px solid #F0E9DC", transition: "all 0.2s" };
      const badge = { display: "inline-block", padding: "2px 6px", borderRadius: 4, fontSize: 9, fontWeight: 600, marginRight: 4, marginBottom: 4, textTransform: "uppercase", letterSpacing: "0.3px" };
      const levelPill = { display: "inline-flex", alignItems: "center", justifyContent: "center", minWidth: 20, height: 20, padding: "0 6px", borderRadius: 10, background: "#8B4513", color: "white", fontSize: 11, fontWeight: 700, marginLeft: 8 };
      const toastContainer = { position: "fixed", top: 12, right: 12, zIndex: 9999, display: "flex", flexDirection: "column", gap: 6 };
      const toastStyle = (type) => ({ padding: "8px 14px", borderRadius: 6, color: "white", fontSize: 12, fontWeight: 500, boxShadow: "0 2px 8px rgba(0,0,0,0.15)", background: type === "success" ? "#10B981" : type === "error" ? "#EF4444" : "#3B82F6", animation: "slideIn 0.3s ease" });

      const courseData = selectedCourse;
      const totalTopics = courseData ? courseData.levels.reduce((sum, l) => sum + l.topics.length, 0) : 0;
      const totalActivities = courseData ? courseData.levels.reduce((sum, l) => sum + l.topics.reduce((s, t) => s + getActivitiesForTopic(t.id).length, 0), 0) : 0;

      return (
        <div style={container}>
          <style>{`@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } button:hover { transform: translateY(-1px); }`}</style>
          <div style={toastContainer}>{toasts.map((t) => <div key={t.id} style={toastStyle(t.type)}>{t.msg}</div>)}</div>

          {loading && (
            <div style={{ maxWidth: 1400, margin: "0 auto", padding: 40, textAlign: "center" }}>
              <div style={{ fontSize: 16, color: "#8B7355", marginBottom: 12 }}>Loading from Supabase...</div>
              <div style={{ fontSize: 12, color: "#A0A0A0" }}>Fetching courses, topics & activities</div>
            </div>
          )}

          {error && (
            <div style={{ maxWidth: 1400, margin: "0 auto", padding: 20, background: "#FEE2E2", borderRadius: 8, border: "1px solid #FCA5A5" }}>
              <div style={{ fontSize: 14, fontWeight: 600, color: "#991B1B", marginBottom: 4 }}>Error Loading Data</div>
              <div style={{ fontSize: 12, color: "#7F1D1D" }}>{error}</div>
            </div>
          )}

          {!loading && !error && (
          <div style={{ maxWidth: 1400, margin: "0 auto" }}>

            {/* Course selection view - grouped by area */}
            {!selectedCourse && (
              <div>
                <div style={{ marginBottom: 16 }}>
                  <h1 style={{ margin: 0, fontSize: 20, fontFamily: "'Playfair Display', serif", color: "#2C1810", fontWeight: 700 }}>
                    Afterhours Courses
                  </h1>
                  <div style={{ fontSize: 11, color: "#8B7355", marginTop: 4 }}>{courses.length} Courses across {areas.length} Areas</div>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 16 }}>
                {areas.map(area => {
                  const areaCourses = courses.filter(c => c.area_id === area.id);
                  if (areaCourses.length === 0) return null;
                  const statusPill = { display: "inline-block", padding: "2px 8px", borderRadius: 10, fontSize: 9, fontWeight: 600, letterSpacing: "0.3px", textTransform: "uppercase", whiteSpace: "nowrap" };
                  const statusStyles = {
                    ACTIVE: { ...statusPill, background: "rgba(209,250,229,0.9)", color: "#065F46" },
                    COMING_SOON: { ...statusPill, background: "rgba(254,243,199,0.9)", color: "#92400E" },
                    DRAFT: { ...statusPill, background: "rgba(243,244,246,0.9)", color: "#9CA3AF" },
                  };
                  const areaImgs = {
                    '9af1fd24-e927-4150-b5af-106294a73e72': 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=600&q=80',
                    '2dc92569-9f3d-4db1-86bb-532d5a64b02f': 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=600&q=80',
                    '16ef8886-4778-4b49-a5e7-ed9a40e758e6': 'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=600&q=80',
                    '4206cc87-9160-4daa-834f-87cdc4f4da9b': 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=600&q=80',
                    'ed364f80-877f-463e-9e00-d66ac505af8e': 'https://images.unsplash.com/photo-1497032628192-86f99bcd76bc?w=600&q=80',
                    '1e74e2f3-c24a-4eb7-b5ae-ef8faa3d1e80': 'https://images.unsplash.com/photo-1456324504439-367cee3b3c32?w=600&q=80',
                    'f3c61d89-723e-47ac-a5c9-90bfd859404d': 'https://images.unsplash.com/photo-1452587925148-ce544e77e70d?w=600&q=80',
                    '74c5853c-82de-433c-925f-1d2baca64dc6': 'https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=600&q=80',
                  };
                  const bgImg = areaImgs[area.id] || '';
                  return (
                    <div key={area.id} style={{ borderRadius: 10, overflow: "hidden", boxShadow: "0 2px 8px rgba(0,0,0,0.1)", position: "relative", backgroundImage: `url(${bgImg})`, backgroundSize: "cover", backgroundPosition: "center", display: "flex", flexDirection: "column" }}>
                      {/* Dark overlay */}
                      <div style={{ position: "absolute", inset: 0, background: "rgba(0,0,0,0.6)", borderRadius: 10 }} />
                      {/* Content on top */}
                      <div style={{ position: "relative", zIndex: 1, padding: 14, display: "flex", flexDirection: "column", height: "100%" }}>
                        <div style={{ marginBottom: 10 }}>
                          <div style={{ display: "flex", alignItems: "center" }}>
                            <h2 style={{ margin: 0, fontSize: 13, color: "white", fontWeight: 700 }}>{area.title}</h2>
                            <div style={{ ...levelPill, background: "rgba(255,255,255,0.25)", color: "white" }}>{areaCourses.length}</div>
                          </div>
                          {area.description && <div style={{ fontSize: 10, color: "rgba(255,255,255,0.7)", marginTop: 2 }}>{area.description}</div>}
                        </div>
                        <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                          {areaCourses.map(course => {
                            const isDraft = course.status === 'DRAFT';
                            const topicCount = course.levels.reduce((sum, l) => sum + l.topics.length, 0);
                            const actCount = course.levels.reduce((sum, l) => sum + l.topics.reduce((s, t) => s + getActivitiesForTopic(t.id).length, 0), 0);
                            return (
                              <div key={course.id} style={{ background: "rgba(255,255,255,0.93)", borderRadius: 6, padding: "8px 10px", cursor: "pointer", opacity: isDraft ? 0.5 : 1, transition: "all 0.2s" }} onClick={() => setSelectedCourse(course)} onMouseEnter={(e) => (e.currentTarget.style.background = "rgba(255,255,255,1)")} onMouseLeave={(e) => (e.currentTarget.style.background = "rgba(255,255,255,0.93)")}>
                                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                  {course.icon && <img src={APP_URL + course.icon} alt="" style={{ width: 22, height: 22, flexShrink: 0 }} onError={(e) => e.target.style.display = 'none'} />}
                                  <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ fontSize: 12, fontWeight: 600, color: "#2C1810" }}>{course.title}</div>
                                    <div style={{ fontSize: 10, color: "#8B7355", marginTop: 1 }}>{course.levels.length}L &bull; {topicCount}T &bull; {actCount}A</div>
                                    {course.skill_tags && course.skill_tags.length > 0 && <div style={{ display: "flex", flexWrap: "wrap", gap: 3, marginTop: 3 }}>{course.skill_tags.map((tag, i) => <span key={i} style={{ fontSize: 8, padding: "1px 5px", borderRadius: 8, background: "#F0E9DC", color: "#8B7355", fontWeight: 500, lineHeight: "14px" }}>{tag}</span>)}</div>}
                                  </div>
                                  <span style={statusStyles[course.status] || statusStyles.DRAFT}>{(course.status || 'DRAFT').replace('_', ' ')}</span>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  );
                })}
                </div>
              </div>
            )}

            {/* Level/topic view (existing UI) */}
            {selectedCourse && (
              <div>
                <div style={{ marginBottom: 16, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                  <div>
                    <h1 style={{ margin: 0, fontSize: 20, fontFamily: "'Playfair Display', serif", color: "#2C1810", fontWeight: 700 }}>
                      {selectedTopic ? selectedTopic.title : courseData.title}
                    </h1>
                    {!selectedTopic && (<><div style={{ fontSize: 11, color: "#8B7355", marginTop: 4 }}>{courseData.levels.length} Levels &bull; {totalTopics} Topics &bull; {totalActivities} Activities</div></>)}
                  </div>
                  <div style={{ display: "flex", gap: 6 }}>
                    {selectedTopic && hasChanges && <button onClick={saveChanges} disabled={saving} style={{ background: "#8B4513", color: "white", border: "none", padding: "4px 14px", borderRadius: 6, cursor: saving ? "wait" : "pointer", fontSize: 12, fontWeight: 600, transition: "all 0.2s", opacity: saving ? 0.6 : 1 }}>{saving ? 'Saving...' : 'Save'}</button>}
                    {selectedTopic && <button onClick={backToTopics} style={btnSecondary}>&larr; Back</button>}
                    {!selectedTopic && <button onClick={backToCourses} style={btnSecondary}>&larr; Courses</button>}
                  </div>
                </div>
                {!selectedTopic && courseData.levels.map((level) => (
                  <div key={level.id} style={{ marginBottom: 20 }}>
                    <div style={{ marginBottom: 8, display: "flex", alignItems: "center" }}><h2 style={{ margin: 0, fontSize: 14, color: "#2C1810", fontWeight: 700 }}>{level.title}</h2><div style={levelPill}>{level.topics.length}</div></div>
                    <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                      {level.topics.map((topic) => {
                        const topicActivities = getActivitiesForTopic(topic.id);
                        const activityCount = topicActivities.length;
                        const breakdown = getTypeBreakdown(topicActivities);
                        const total = activityCount;
                        return (
                          <div key={topic.id} style={{ ...card, display: "flex", flexDirection: "column", padding: 10, cursor: "pointer" }} onClick={() => setSelectedTopic(topic)} onMouseEnter={(e) => (e.currentTarget.style.boxShadow = "0 2px 8px rgba(139,69,19,0.12)")} onMouseLeave={(e) => (e.currentTarget.style.boxShadow = "0 1px 4px rgba(0,0,0,0.06)")}>
                            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: activityCount > 0 ? 8 : 0 }}>
                              <div style={{ flex: 1 }}>
                                <div style={{ fontSize: 13, fontWeight: 600, color: "#2C1810", marginBottom: 4 }}>{topic.title}</div>
                                {topic.tags && topic.tags.length > 0 && (<div style={{ display: "flex", flexWrap: "wrap" }}>{topic.tags.map((tag, idx) => <span key={idx} style={{ ...badge, background: "#F5F1E8", color: "#8B4513", border: "1px solid #D4C4B0" }}>{tag}</span>)}</div>)}
                              </div>
                              <div style={{ fontSize: 16, fontWeight: 700, color: activityCount > 0 ? "#8B4513" : "#D4C4B0", marginLeft: 16, minWidth: 30, textAlign: "right" }}>{activityCount}</div>
                            </div>
                            {activityCount > 0 && (
                              <div style={{ display: "flex", height: 6, borderRadius: 3, overflow: "hidden", background: "#F5F1E8" }}>
                                {Object.entries(breakdown).map(([type, count]) => {
                                  const percentage = (count / total) * 100;
                                  return (
                                    <div key={type} title={`${typeLabels[type] || type}: ${count}`} style={{ width: `${percentage}%`, background: typeColors[type] || "#9CA3AF", transition: "opacity 0.2s" }} onMouseEnter={(e) => (e.currentTarget.style.opacity = "0.8")} onMouseLeave={(e) => (e.currentTarget.style.opacity = "1")} />
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
                {selectedTopic && (
                  <div>
                    <div style={{ marginBottom: 12 }}>
                      {selectedTopic.tags && selectedTopic.tags.length > 0 && (<div style={{ display: "flex", flexWrap: "wrap", marginBottom: 8 }}>{selectedTopic.tags.map((tag, idx) => <span key={idx} style={{ ...badge, background: "#F5F1E8", color: "#8B4513", border: "1px solid #D4C4B0" }}>{tag}</span>)}</div>)}
                      <div style={{ fontSize: 11, color: "#8B7355" }}>{getActivitiesForTopic(selectedTopic.id).length} {getActivitiesForTopic(selectedTopic.id).length === 1 ? "activity" : "activities"}</div>
                    </div>
                    {getActivitiesForTopic(selectedTopic.id).length === 0 ? (
                      <div style={card}><div style={{ textAlign: "center", padding: 20, color: "#8B7355", fontSize: 12 }}>No activities yet for this topic.</div></div>
                    ) : (
                      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                        {getActivitiesForTopic(selectedTopic.id).map((activity, idx) => (
                          <div key={activity.id || idx} draggable
                            onDragStart={(e) => { setDragIdx(idx); e.dataTransfer.effectAllowed = 'move'; }}
                            onDragOver={(e) => { e.preventDefault(); setDragOverIdx(idx); }}
                            onDrop={(e) => { e.preventDefault(); onDrop(selectedTopic.id, dragIdx, idx); setDragIdx(null); setDragOverIdx(null); }}
                            onDragEnd={() => { setDragIdx(null); setDragOverIdx(null); }}
                            style={{ ...card, cursor: "grab", borderTop: dragOverIdx === idx && dragIdx !== idx ? "2px solid #8B4513" : card.border, opacity: dragIdx === idx ? 0.4 : 1 }}>
                            <div style={{ display: "flex", alignItems: "start", gap: 10 }}>
                              <div style={{ minWidth: 22, height: 22, borderRadius: "50%", background: "#F5F1E8", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 600, color: "#8B4513", cursor: "grab" }}>{idx + 1}</div>
                              <div style={{ flex: 1 }}>
                                <div style={{ marginBottom: 8 }}>
                                  <div style={{ display: "inline-block", padding: "2px 8px", borderRadius: 4, background: "#F5F1E8", fontSize: 9, fontWeight: 700, color: "#8B4513", textTransform: "uppercase", letterSpacing: "0.5px" }}>{activity.type.replace(/_/g, " ")}</div>
                                  {Array.isArray(activity.correct_answer) && <span style={{ marginLeft: 6, padding: "2px 6px", borderRadius: 4, background: "#DDD6FE", color: "#5B21B6", fontSize: 9, fontWeight: 600, textTransform: "uppercase" }}>MULTI-ANSWER</span>}
                                </div>
                                <EditableText
                                  value={edits[activity.id]?.main_text !== undefined ? edits[activity.id].main_text : activity.main_text}
                                  fieldKey={activity.id + ':main_text'}
                                  style={{ fontSize: 13, color: "#2C1810", lineHeight: 1.5, marginTop: 6 }}
                                  multiline
                                  onCommit={(val) => stageEdit(activity.id, 'main_text', val)}
                                />
                                {activity.options && activity.options.length > 0 && (
                                  <div style={{ marginTop: 10 }}>
                                    {activity.options.map((option, optIdx) => {
                                      const isCorrect = isCorrectOption(activity, optIdx);
                                      const explanation = getOptionExplanation(activity, optIdx);
                                      const editedOpt = edits[activity.id]?.options?.[optIdx];
                                      const editedExpl = edits[activity.id]?.explanations?.[optIdx];
                                      return (
                                        <div key={optIdx} style={{ padding: "8px 12px", marginBottom: 4, borderRadius: 6, background: isCorrect ? "#D1FAE5" : "#F9FAFB", border: isCorrect ? "1px solid #6EE7B7" : "1px solid #E5E7EB", fontSize: 12, color: isCorrect ? "#065F46" : "#374151" }}>
                                          <EditableText
                                            value={editedOpt !== undefined ? editedOpt : option}
                                            fieldKey={activity.id + ':opt:' + optIdx}
                                            style={{ fontSize: 12, color: isCorrect ? "#065F46" : "#374151" }}
                                            onCommit={(val) => stageEdit(activity.id, 'option', val, optIdx)}
                                          />
                                          <EditableText
                                            value={editedExpl !== undefined ? editedExpl : (explanation || '')}
                                            fieldKey={activity.id + ':expl:' + optIdx}
                                            style={{ fontSize: 10, marginTop: 4, color: isCorrect ? "#047857" : "#6B7280", fontStyle: "italic", lineHeight: 1.4 }}
                                            multiline
                                            onCommit={(val) => stageEdit(activity.id, 'explanation', val, optIdx)}
                                          />
                                        </div>
                                      );
                                    })}
                                  </div>
                                )}
                                {activity.author_comment && <div style={{ marginTop: 8, fontSize: 10, color: "#8B7355", fontStyle: "italic", lineHeight: 1.4 }} dangerouslySetInnerHTML={{ __html: activity.author_comment }} />}
                                {activity.embed_url && <div style={{ marginTop: 10 }}><a href={activity.embed_url} target="_blank" rel="noopener noreferrer" style={{ color: "#8B4513", fontSize: 11, textDecoration: "none", fontWeight: 600 }}>&#128279; View Resource &rarr;</a></div>}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

          </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ActivityBuilder />);
  </script>
</body>
</html>
